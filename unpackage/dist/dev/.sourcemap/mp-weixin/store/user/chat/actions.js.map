{"version":3,"file":"actions.js","sources":["store/user/chat/actions.js"],"sourcesContent":["/**\n * chat模块的actions\n * @module store/user/chat/actions\n */\n\nexport default {\n        // 初始化IM连接\n    async initIM({ commit, dispatch }, { userId, token }) {\n      commit('SET_CONNECTION_STATUS', { isConnected: false, isConnecting: true })\n      \n      try {\n        // 初始化IMBox SDK\n        await IMBox.init({\n          appId: 'your-app-id',\n          userId,\n          token\n        })\n        \n        // 设置监听器\n        IMBox.on('message', (message) => {\n          dispatch('handleNewMessage', message)\n        })\n        \n        IMBox.on('connection-status-changed', (status) => {\n          commit('SET_CONNECTION_STATUS', {\n            isConnected: status === 'connected',\n            isConnecting: status === 'connecting'\n          })\n        })\n        \n        // 连接成功\n        commit('SET_CONNECTION_STATUS', { isConnected: true, isConnecting: false })\n        \n        // 加载会话列表\n        await dispatch('loadSessions')\n        \n      } catch (error) {\n        commit('SET_CONNECTION_ERROR', error)\n        commit('SET_CONNECTION_STATUS', { isConnected: false, isConnecting: false })\n        throw error\n      }\n    },\n    \n    // 加载会话列表\n    async loadSessions({ commit }) {\n      try {\n        const sessions = await IMBox.getSessions()\n        sessions.forEach(session => {\n          commit('ADD_OR_UPDATE_SESSION', {\n            sessionId: session.sessionId,\n            sessionType: session.type,\n            targetId: session.targetId,\n            title: session.title,\n            avatar: session.avatar,\n            lastMessage: session.lastMessage,\n            unreadCount: session.unreadCount,\n            lastMessageTime: session.lastMessageTime\n          })\n        })\n      } catch (error) {\n        console.error('加载会话列表失败:', error)\n        throw error\n      }\n    },\n    \n    // 处理新消息\n    async handleNewMessage({ commit, state }, message) {\n      const { sessionId } = message\n      \n      // 添加到消息列表\n      commit('ADD_MESSAGE', { sessionId, message })\n      \n      // 更新会话最后消息\n      commit('UPDATE_SESSION_LAST_MESSAGE', { sessionId, message })\n      \n      // 如果当前不是这个会话，增加未读数\n      if (state.currentSession.sessionId !== sessionId || !state.currentSession.isActive) {\n        const session = state.sessions.byId[sessionId]\n        if (session) {\n          commit('ADD_OR_UPDATE_SESSION', {\n            sessionId,\n            unreadCount: (session.unreadCount || 0) + 1\n          })\n        }\n      }\n      \n      // 如果是当前会话且活跃，标记为已读\n      if (state.currentSession.sessionId === sessionId && state.currentSession.isActive) {\n        await IMBox.markAsRead(sessionId)\n      }\n    },\n    \n    // 发送消息\n    async sendMessage({ commit, state }, { sessionId, content, type = 'text' }) {\n      const message = {\n        id: `temp-${Date.now()}`, // 临时ID，发送成功后会替换\n        type,\n        content,\n        senderId: state.currentUser.userId,\n        time: Math.floor(Date.now() / 1000),\n        status: 'sending',\n        isSelf: true\n      }\n      \n      // 先添加到本地\n      commit('ADD_MESSAGE', { sessionId, message })\n      \n      try {\n        // 调用IMBox发送\n        const sentMessage = await IMBox.sendMessage({\n          sessionId,\n          type,\n          content\n        })\n        \n        // 更新消息状态和ID\n        commit('UPDATE_MESSAGE_STATUS', {\n          sessionId,\n          messageId: message.id,\n          status: 'sent'\n        })\n        \n        // 更新会话最后消息\n        commit('UPDATE_SESSION_LAST_MESSAGE', {\n          sessionId,\n          message: sentMessage\n        })\n        \n        return sentMessage\n      } catch (error) {\n        commit('UPDATE_MESSAGE_STATUS', {\n          sessionId,\n          messageId: message.id,\n          status: 'failed'\n        })\n        throw error\n      }\n    },\n    \n    // 加载历史消息\n    async loadHistoryMessages({ commit, state }, { sessionId, lastMessageId }) {\n      if (state.messages.bySessionId[sessionId]?.isLoading) return\n      \n      commit('SET_MESSAGES_LOADING', { sessionId, isLoading: true })\n      \n      try {\n        const messages = await IMBox.getHistoryMessages({\n          sessionId,\n          before: lastMessageId,\n          limit: 20\n        })\n        \n        if (messages.length > 0) {\n          commit('PREPEND_MESSAGES', { sessionId, messages })\n        } else {\n          commit('SET_NO_MORE_MESSAGES', { sessionId })\n        }\n      } catch (error) {\n        console.error('加载历史消息失败:', error)\n        throw error\n      } finally {\n        commit('SET_MESSAGES_LOADING', { sessionId, isLoading: false })\n      }\n    },\n    \n    // 切换会话\n    async switchSession({ commit, dispatch }, sessionId) {\n      // 更新当前会话\n      const session = this.state.sessions.byId[sessionId]\n      commit('SET_CURRENT_SESSION', {\n        sessionId,\n        targetId: session.targetId,\n        sessionType: session.sessionType,\n        isActive: true,\n        unreadCount: 0\n      })\n      \n      // 重置会话未读数\n      commit('ADD_OR_UPDATE_SESSION', {\n        sessionId,\n        unreadCount: 0\n      })\n      \n      // 标记为已读\n      await IMBox.markAsRead(sessionId)\n      \n      // 加载消息\n      if (!this.state.messages.bySessionId[sessionId]) {\n        await dispatch('loadHistoryMessages', { sessionId })\n      }\n    }\n}; \n"],"names":["uni"],"mappings":"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"}